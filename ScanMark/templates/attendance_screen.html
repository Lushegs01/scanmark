{% extends "base.html" %}

{% block content %}
<div class="container text-center mt-5">
    <div class="card shadow-lg mx-auto" style="max-width: 600px;">
        <div class="card-header bg-dark text-white">
            <h3>{{ course.code }} Attendance</h3>
            <p class="mb-0">{{ course.title }}</p>
        </div>
        <div class="card-body p-5">
            
            <div id="qrcode" class="d-flex justify-content-center"></div>

            <h5 class="mt-4 text-muted">Scan with ScanMark</h5>
            
            <input type="hidden" id="courseId" value="{{ course.id }}">

            <div class="alert alert-info mt-3">
                <div class="spinner-grow spinner-grow-sm text-info" role="status"></div>
                Code refreshes every 5 seconds
            </div>
        </div>
        <div class="card-footer">
            <a href="/dashboard" class="btn btn-danger">Stop Attendance</a>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
    const courseId = document.getElementById('courseId').value;
    const qrContainer = document.getElementById("qrcode");
    
    // Initialize the QR Code generator
    const qrcode = new QRCode(qrContainer, {
        width: 300,
        height: 300
    });

    function updateQR() {
        // Fetch the TEXT data from the server (not an image)
        fetch(`/api/qr_data/${courseId}`)
            .then(response => response.json())
            .then(data => {
                // Tell the library to re-draw the box with new text
                qrcode.makeCode(data.qr_text);
            })
            .catch(err => console.error("Error fetching QR data:", err));
    }

    // Run immediately, then every 5 seconds
    updateQR();
    setInterval(updateQR, 5000);

    // ... (keep your existing updateQR code) ...

    // NEW: Get Lecturer's Location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            
            // Send to server
            fetch(`/set_location/${courseId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lat: lat, lon: lon })
            });
            console.log("Lecturer Location Sent:", lat, lon);
        }, error => {
            alert("Please allow location access to enable Geo-Fencing.");
        });
    } else {
        alert("Geolocation is not supported by this browser.");
    }
</script>
{% endblock %}