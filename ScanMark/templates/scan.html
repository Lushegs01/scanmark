{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row mb-4 align-items-center">
        <div class="col-md-8">
            <h2 class="fw-bold">My Portal</h2>
            <p class="text-muted">Welcome back, {{ current_user.full_name }}</p>
        </div>
        <div class="col-md-4 text-end">
            <button onclick="startScanner()" class="btn btn-success btn-lg shadow-sm">
                ğŸ“· Start Camera
            </button>
        </div>
    </div>

    <div id="reader" style="width: 100%; border-radius: 15px; overflow: hidden; display:none;"></div>

    <div id="zoom-container" style="display:none; margin-top: 20px; text-align: center; background: #f8f9fa; padding: 15px; border-radius: 10px;">
        <label for="zoom-slider" style="font-weight: bold; font-size: 1.2rem; color: #198754;">ğŸ” Zoom: <span id="zoom-value">1.0x</span></label>
        <br>
        <input type="range" id="zoom-slider" min="1" max="5" step="0.1" value="1" style="width: 100%; height: 25px; accent-color: #198754;">
    </div>

    <div class="card shadow-sm border-0 mt-4">
        <div class="card-header bg-white py-3">
            <h5 class="mb-0 fw-bold text-success">ğŸ“Š My Attendance Records</h5>
        </div>
        <div class="card-body p-0">
            {% if attendance_data %}
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4">Course Code</th>
                            <th>Course Title</th>
                            <th class="text-center">Classes Attended</th>
                            <th class="text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in attendance_data %}
                        <tr>
                            <td class="ps-4 fw-bold">{{ item.code }}</td>
                            <td class="text-muted">{{ item.title }}</td>
                            <td class="text-center">
                                <span class="badge bg-primary fs-6">{{ item.count }}</span>
                            </td>
                            <td class="text-center">
                                <span class="text-success small fw-bold">Active</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <span style="font-size: 3rem;">ğŸ“­</span>
                <p class="mt-3 text-muted">You haven't marked attendance for any courses yet.</p>
                <button onclick="startScanner()" class="btn btn-outline-success btn-sm">Start Scanning</button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
    let html5QrCode;

    function startScanner() {
        // Show the camera box
        document.getElementById('reader').style.display = 'block';

        // 1. Configure "Google Lens" Settings (4K + Continuous Focus)
        const config = {
            fps: 10,
            qrbox: { width: 250, height: 250 },
            videoConstraints: {
                facingMode: "environment",
                width: { ideal: 4096 }, // Force Max Resolution
                height: { ideal: 2160 },
                focusMode: "continuous" // Autofocus
            }
        };

        html5QrCode = new Html5Qrcode("reader");

        html5QrCode.start(
            { facingMode: "environment" },
            config,
            (decodedText, decodedResult) => {
                // --- SUCCESS: Code Scanned! ---
                console.log(`Code matched = ${decodedText}`, decodedResult);
                
                // Stop camera immediately to prevent double-scanning
                html5QrCode.stop().then(() => {
                    document.getElementById('reader').style.display = 'none';
                    document.getElementById('zoom-container').style.display = 'none';
                    
                    // Call the function to send data to backend
                    processAttendance(decodedText);
                });
            },
            (errorMessage) => {
                // scanning... ignore errors
            }
        ).then(() => {
            // --- ZOOM FEATURE ---
            enableZoom();
        }).catch(err => {
            alert("Error starting camera: " + err);
        });
    }

    function enableZoom() {
        // Get the video track to control zoom
        // Note: Different browsers handle this slightly differently
        // We try the standard method first
        
        // Wait 500ms for camera to stabilize
        setTimeout(() => {
            const videoElement = document.querySelector("#reader video");
            if (!videoElement) return;

            // Try to find the stream track
            const track = html5QrCode.scanner?.html5QrCode?.localMediaStream?.getVideoTracks()[0] 
                       || videoElement.srcObject?.getVideoTracks()[0];

            if (track) {
                const capabilities = track.getCapabilities();
                const zoomControl = document.getElementById("zoom-slider");
                const zoomContainer = document.getElementById("zoom-container");
                const zoomValueDisplay = document.getElementById("zoom-value");

                if (capabilities.zoom) {
                    // Reveal the slider!
                    zoomContainer.style.display = "block";
                    zoomControl.min = capabilities.zoom.min;
                    zoomControl.max = capabilities.zoom.max;
                    zoomControl.step = capabilities.zoom.step || 0.1;
                    zoomControl.value = 1;

                    zoomControl.oninput = function () {
                        zoomValueDisplay.innerText = this.value + "x";
                        track.applyConstraints({
                            advanced: [{ zoom: parseFloat(this.value) }]
                        });
                    };
                }
            }
        }, 1000);
    }

    function processAttendance(qrData) {
        // 1. Get GPS Location (Required for your app!)
        if (!navigator.geolocation) {
            alert("Geolocation is not supported by your browser");
            return;
        }

        alert("Code Scanned! Verifying Location... ğŸŒ");

        navigator.geolocation.getCurrentPosition(position => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            // 2. Send to Backend
            fetch('/mark_attendance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    qr_code: qrData,
                    latitude: lat,
                    longitude: lon
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert("âœ… Success: " + data.message);
                    location.reload(); // Refresh to see new attendance count
                } else {
                    alert("âŒ Error: " + data.message);
                }
            })
            .catch(error => {
                alert("Server Error: " + error);
            });

        }, () => {
            alert("âŒ Location access denied! We cannot verify your attendance without GPS.");
        });
    }
</script>
{% endblock %}
