{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-6">
            
            <div class="card shadow-lg border-0 overflow-hidden">
                <div class="card-header bg-dark text-white text-center py-3">
                    <h5 class="mb-0">üì∑ Scan Attendance QR</h5>
                </div>
                
                <div class="card-body p-0 bg-black">
                    <div id="reader" style="width: 100%; min-height: 300px;"></div>
                </div>
                
                <div class="card-footer bg-white p-3 text-center">
                    <div id="result">
                        <p class="text-muted mb-0">Point your camera at the lecturer's screen.</p>
                        <small class="text-success fw-bold">üìç GPS Location Active</small>
                    </div>
                    
                    <a href="/dashboard" class="btn btn-outline-secondary btn-sm mt-3">Cancel / Go Back</a>
                </div>
            </div>

        </div>
    </div>
</div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
    function onScanSuccess(decodedText, decodedResult) {
        // Stop scanning immediately
        html5QrcodeScanner.clear();
        
        // Show processing state
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = `
            <div class="spinner-border text-primary mb-2" role="status"></div>
            <h5 class="fw-bold">Processing...</h5>
            <p class="small text-muted">Verifying location & timestamp</p>
        `;

        // 1. Get GPS
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                sendAttendance(decodedText, lat, lon);
            }, 
            error => {
                showError("Location Denied. Please allow GPS permissions.");
            });
        } else {
            // Fallback for devices without GPS support
            sendAttendance(decodedText, null, null);
        }
    }

    function sendAttendance(qrData, lat, lon) {
        fetch('/mark_attendance', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                qr_data: qrData,
                lat: lat,
                lon: lon
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showSuccess(data.message);
            } else {
                showError(data.message);
            }
        })
        .catch(err => {
            showError("Server Connection Failed");
        });
    }

    function showSuccess(msg) {
        document.getElementById('result').innerHTML = `
            <div class="text-success mb-2" style="font-size: 3rem;">‚úÖ</div>
            <h4 class="fw-bold text-success">Success!</h4>
            <p>${msg}</p>
            <a href="/dashboard" class="btn btn-success mt-2">Back to Dashboard</a>
        `;
    }

    function showError(msg) {
        document.getElementById('result').innerHTML = `
            <div class="text-danger mb-2" style="font-size: 3rem;">‚ùå</div>
            <h5 class="fw-bold text-danger">Failed</h5>
            <p class="text-danger small">${msg}</p>
            <button onclick="location.reload()" class="btn btn-outline-danger btn-sm mt-2">Try Again</button>
        `;
    }

    // Initialize Scanner
    let html5QrcodeScanner = new Html5QrcodeScanner(
        "reader", 
        { fps: 10, qrbox: {width: 250, height: 250} },
        /* verbose= */ false
    );
    html5QrcodeScanner.render(onScanSuccess);
</script>
{% endblock %}